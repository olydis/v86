<!doctype html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<title>AOE</title>
<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">

<style>
body
{
    padding: 0;
    margin: 0;
}
#screen_container
{

}
</style>

<script src="loader.js"></script>
<script src="loader.js"></script>
<script>

function $(id)
{
    var el = document.getElementById(id);

    if(!el)
    {
        dbg_log("Element with id `" + id + "` not found");
    }

    return el;
}

function init_ui(settings, emulator)
{
    $("runtime_options").style.display = "block";
    $("runtime_infos").style.display = "block";

    $("run").onclick = function()
    {
        if(emulator.is_running())
        {
            $("run").value = "Run";
            emulator.stop();
        }
        else
        {
            $("run").value = "Pause";
            emulator.run();
        }

        $("run").blur();
    };

    $("exit").onclick = function()
    {
        emulator.stop();
        location.href = location.pathname;
    };

    $("lock_mouse").onclick = function()
    {
        if(!mouse_is_enabled)
        {
            $("toggle_mouse").onclick();
        }

        emulator.lock_mouse();
        $("lock_mouse").blur();
    };

    var mouse_is_enabled = true;

    $("toggle_mouse").onclick = function()
    {
        mouse_is_enabled = !mouse_is_enabled;

        emulator.mouse_set_status(mouse_is_enabled);
        $("toggle_mouse").value = (mouse_is_enabled ? "Dis" : "En") + "able mouse";
        $("toggle_mouse").blur();
    };


    var last_tick = 0;
    var running_time = 0;
    var last_instr_counter = 0;
    var interval;
    var os_uses_mouse = false;

    function update_info()
    {
        var now = Date.now();

        var instruction_counter = emulator.get_instruction_counter();
        var last_ips = instruction_counter - last_instr_counter;

        last_instr_counter = instruction_counter;

        var delta_time = now - last_tick;
        running_time += delta_time;
        last_tick = now;

        $("speed").textContent = last_ips / delta_time | 0;
        $("avg_speed").textContent = instruction_counter / running_time | 0;
        $("running_time").textContent = time2str(running_time / 1000 | 0);
    }

    emulator.add_listener("emulator-started", function()
    {
        last_tick = Date.now();
        interval = setInterval(update_info, 1000);
    });

    emulator.add_listener("emulator-stopped", function()
    {
        update_info();
        clearInterval(interval);
    });

    var stats_9p = {
        read: 0,
        write: 0,
    };

    var stats_storage = {
        read: 0,
        read_sectors: 0,
        write: 0,
        write_sectors: 0,
    };

    emulator.add_listener("ide-read-start", function()
    {
        $("info_storage").style.display = "block";
        $("info_storage_status").textContent = "Loading ...";
    });
    emulator.add_listener("ide-read-end", function(args)
    {
        stats_storage.read += args[1];
        stats_storage.read_sectors += args[2];

        $("info_storage_status").textContent = "Idle";
        $("info_storage_bytes_read").textContent = stats_storage.read;
        $("info_storage_sectors_read").textContent = stats_storage.read_sectors;
    });
    emulator.add_listener("ide-write-end", function(args)
    {
        stats_storage.write += args[1];
        stats_storage.write_sectors += args[2];

        $("info_storage_bytes_written").textContent = stats_storage.write;
        $("info_storage_sectors_written").textContent = stats_storage.write_sectors;
    });

    var stats_net = {
        bytes_transmitted: 0,
        bytes_received: 0,
    };

    emulator.add_listener("mouse-enable", function(is_enabled)
    {
        os_uses_mouse = is_enabled;
        $("info_mouse_enabled").textContent = is_enabled ? "Yes" : "No";
    });

    emulator.add_listener("screen-set-mode", function(is_graphical)
    {
        if(is_graphical)
        {
            $("info_vga_mode").textContent = "Graphical";
        }
        else
        {
            $("info_vga_mode").textContent = "Text";
            $("info_res").textContent = "-";
            $("info_bpp").textContent = "-";
        }
    });
    emulator.add_listener("screen-set-size-graphical", function(args)
    {
        $("info_res").textContent = args[0] + "x" + args[1];
        $("info_bpp").textContent = args[2];
    });


    $("reset").onclick = function()
    {
        emulator.restart();
        $("reset").blur();
    };

    $("memory_dump").onclick = function()
    {
        dump_file(emulator.v86.cpu.mem8, "v86memory.bin");
        $("memory_dump").blur();
    };

    $("save_state").onclick = function()
    {
        emulator.save_state(function(error, result)
        {
            if(error)
            {
                console.log(error.stack);
                console.log("Couldn't save state: ", error);
            }
            else
            {
                dump_file(result, "v86state.bin");
            }
        });

        $("save_state").blur();
    };

    $("load_state").onclick = function()
    {
        $("load_state_input").click();
        $("load_state").blur();
    };

    $("load_state_input").onchange = function()
    {
        var file = this.files[0];

        if(!file)
        {
            return;
        }

        var was_running = emulator.is_running();

        if(was_running)
        {
            emulator.stop();
        }

        var filereader = new FileReader();
        filereader.onload = function(e)
        {
            try
            {
                emulator.restore_state(e.target.result);
            }
            catch(e)
            {
                alert("Something bad happened while restoring the state:\n" + e + "\n\n" +
                        "Note that the current configuration must be the same as the original");
                throw e;
            }

            if(was_running)
            {
                emulator.run();
            }
        };
        filereader.readAsArrayBuffer(file);

        this.value = "";
    };

    $("ctrlaltdel").onclick = function()
    {
        emulator.keyboard_send_scancodes([
            0x1D, // ctrl
            0x38, // alt
            0x53, // delete

            // break codes
            0x1D | 0x80,
            0x38 | 0x80,
            0x53 | 0x80,
        ]);

        $("ctrlaltdel").blur();
    };

    $("alttab").onclick = function()
    {
        emulator.keyboard_send_scancodes([
            0x38, // alt
            0x0F, // tab
        ]);

        setTimeout(function()
        {
            emulator.keyboard_send_scancodes([
                0x38 | 0x80,
                0x0F | 0x80,
            ]);
        }, 100);

        $("alttab").blur();
    };

    $("scale").onchange = function()
    {
        var n = parseFloat(this.value);

        if(n || n > 0)
        {
            emulator.screen_set_scale(n, n);
        }
    };

    $("fullscreen").onclick = function()
    {
        emulator.screen_go_fullscreen();
    };

    $("screen_container").onclick = function()
    {
        if(mouse_is_enabled && os_uses_mouse)
        {
            emulator.lock_mouse();
            $("lock_mouse").blur();
        }
        else
        {
            // allow text selection
            if(window.getSelection().isCollapsed)
            {
                let phone_keyboard = document.getElementsByClassName("phone_keyboard")[0];

                // stop mobile browser from scrolling into view when the keyboard is shown
                phone_keyboard.style.top = document.body.scrollTop + 100 + "px";
                phone_keyboard.style.left = document.body.scrollLeft + 100 + "px";

                phone_keyboard.focus();
            }
        }
    };

    $("take_screenshot").onclick = function()
    {
        emulator.screen_make_screenshot();

        $("take_screenshot").blur();
    };

    $("serial").style.display = "block";

    window.addEventListener("keydown", ctrl_w_rescue, false);
    window.addEventListener("keyup", ctrl_w_rescue, false);
    window.addEventListener("blur", ctrl_w_rescue, false);

    function ctrl_w_rescue(e)
    {
        if(e.ctrlKey)
        {
            window.onbeforeunload = function()
            {
                window.onbeforeunload = null;
                return "CTRL-W cannot be sent to the emulator.";
            }
        }
        else
        {
            window.onbeforeunload = null;
        }
    }
}


function start_emulation(settings, done)
{
    /** @const */
    var MB = 1024 * 1024;

    var memory_size = settings.memory_size;

    if(!memory_size)
    {
        memory_size = parseInt($("memory_size").value, 10) * MB;

        if(!memory_size)
        {
            alert("Invalid memory size - reset to 128MB");
            memory_size = 128 * MB;
        }
    }

    var vga_memory_size = settings.vga_memory_size;

    /** @const */
    var BIOSPATH = "bios/";

    if(settings.use_bochs_bios)
    {
        var biosfile = "bochs-bios.bin";
        var vgabiosfile = "bochs-vgabios.bin";
    }
    else
    {
        var biosfile = DEBUG ? "seabios-debug.bin" : "seabios.bin";
        var vgabiosfile = DEBUG ? "vgabios-debug.bin" : "vgabios.bin";
        //var biosfile = DEBUG ? "seabios-ultradebug.bin" : "seabios.bin";
        //var vgabiosfile = DEBUG ? "vgabios-ultradebug.bin" : "vgabios.bin";
    }

    //var biosfile = "seabios-qemu.bin";
    //var vgabiosfile = "vgabios-qemu.bin";

    var bios;
    var vga_bios;

    // a bios is only needed if the machine is booted
    if(!settings.initial_state)
    {
        bios = {
            "url": BIOSPATH + biosfile,
        };
        vga_bios = {
            "url": BIOSPATH + vgabiosfile,
        };
    }

    var emulator = new V86Starter({
        "memory_size": memory_size,
        "vga_memory_size": vga_memory_size,

        "screen_container": $("screen_container"),
        "serial_container": $("serial"),

        "boot_order": settings.boot_order || parseInt($("boot_order").value, 16) || 0,

        "network_relay_url": "wss://relay.widgetry.org/",
        //"network_relay_url": "ws://localhost:8001/",

        "bios": bios,
        "vga_bios": vga_bios,

        "fda": settings.fda,
        "hda": settings.hda,
        "cdrom": settings.cdrom,

        "initial_state": settings.initial_state,
        "filesystem": settings.filesystem || {},

        "autostart": false,
    });

    if(DEBUG) window["emulator"] = emulator;

    emulator.add_listener("emulator-ready", function()
    {
        if(DEBUG)
        {
            //debug_start(emulator);
        }

        init_ui(settings, emulator);

        done && done(emulator);
    });

    emulator.add_listener("download-progress", function(e)
    {
        console.log(e);
    });

    emulator.add_listener("download-error", function(e)
    {
        var el = $("loading");
        el.style.display = "block";
        el.textContent = "Loading " + e.file_name + " failed. Check your connection " +
                            "and reload the page to try again.";
    });
};

loadFinished = main;

function main()
{
    var settings = {};
    settings.initial_state = {
        "url": "images/AOE/v86state_ingame_bench.bin",
        "size": 75726848,
    };
    settings.hda = {
        "url": "images/AOE/windows98x.img",
        "async": true,
        "size": 300 * 1024 * 1024,
    };
    settings.memory_size = 64 * 1024 * 1024;
    settings.vga_memory_size = 8 * 1024 * 1024;
    settings.id = "windows98";
    settings.boot_order = 0x132;

    start_emulation(settings, null);
};

function time2str(time)
{
    if(time < 60)
    {
        return time + "s";
    }
    else if(time < 3600)
    {
        return (time / 60 | 0) + "m " + v86util.pad0(time % 60, 2) + "s";
    }
    else
    {
        return (time / 3600 | 0) + "h " +
            v86util.pad0((time / 60 | 0) % 60, 2) + "m " +
            v86util.pad0(time % 60, 2) + "s";
    }
}
</script>

<div id="screen_container">
    <div id="screen"></div>
    <canvas id="vga"></canvas>
</div>

<div>
    <div id="runtime_options" style="display: none">
        <input type="button" value="Pause" id="run">
        <input type="button" value="Reset" id="reset">
        <input type="button" value="Exit" id="exit">
        <input type="button" value="Send Ctrl-Alt-Del" id="ctrlaltdel">
        <input type="button" value="Send Alt-Tab" id="alttab">
        <input type="button" value="Get floppy image" id="get_fda_image">
        <input type="button" value="Get second floppy image" id="get_fdb_image">
        <input type="button" value="Get hard disk image" id="get_hda_image">
        <input type="button" value="Get second hard disk image" id="get_hdb_image">
        <input type="button" value="Get cdrom image" id="get_cdrom_image">
        <input type="button" value="Save State" id="save_state">
        <input type="button" value="Load State" id="load_state"> <input type="file" style="display: none" id="load_state_input">
        <input type="button" value="Memory Dump" id="memory_dump">
        <input type="button" value="Disable mouse" id="toggle_mouse">
        <input type="button" value="Lock mouse" id="lock_mouse">
        <input type="button" value="Go fullscreen" id="fullscreen">
        <input type="button" value="Take screenshot (only graphic modes)" id="take_screenshot">

        <label>
            Scale:
            <input type="number" min="0.25" step="0.25" value="1.0" id="scale" style="width: 50px">
        </label>
    </div>
</div>


        Running: <span id="running_time">0s</span> <br>
        Speed: <span id="speed">0</span>kIPS<br>
        Avg speed: <span id="avg_speed">0</span>kIPS<br>

<div style="display:none">
    <div id="log_levels"></div>
    <div id="debug_infos"></div>
    <div id="start_emulation"></div>
    <textarea cols="40" rows="12" id="serial"></textarea>
    
    <div id="runtime_infos">
        Running: <span id="running_time">0s</span> <br>
        Speed: <span id="speed">0</span>kIPS<br>
        Avg speed: <span id="avg_speed">0</span>kIPS<br>
        <br>
        <div id="info_storage">
            <b>IDE device (HDA or CDROM)</b><br>
            Sectors read: <span id="info_storage_sectors_read">0</span><br>
            Bytes read: <span id="info_storage_bytes_read">0</span><br>
            Sectors written: <span id="info_storage_sectors_written">0</span><br>
            Bytes written: <span id="info_storage_bytes_written">0</span><br>
            Status: <span id="info_storage_status"></span><br>
            <br>
        </div>
        <div id="info_filesystem">
            <b>9p Filesystem</b><br>
            Bytes read: <span id="info_filesystem_bytes_read">0</span><br>
            Bytes written: <span id="info_filesystem_bytes_written">0</span><br>
            Last file: <span id="info_filesystem_last_file" style="word-wrap: break-word"></span><br>
            Status: <span id="info_filesystem_status"></span><br>
            <br>
        </div>
        <div id="info_network">
            <b>Network</b><br>
            Bytes received: <span id="info_network_bytes_received">0</span><br>
            Bytes transmitted: <span id="info_network_bytes_transmitted">0</span><br>
            <br>
        </div>
        <b>VGA</b><br>
        Mode: <span id="info_vga_mode"></span><br>
        Resolution: <span id="info_res">-</span><br>
        BPP: <span id="info_bpp">-</span><br>
        <br>
        Mouse: <span id="info_mouse_enabled">No</span><br>
    </div>
</div>

